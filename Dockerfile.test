FROM alpine:latest
# Update packages to get latest security fixes
RUN apk update && apk upgrade --no-cache && apk add --quiet --no-cache gcc musl-dev libressl-dev make valgrind bash coreutils

# Create non-root user for security (AVD-DS-0002)
RUN addgroup -S testgroup && adduser -S testuser -G testgroup

COPY ./*.h /opt/src/
COPY ./*.c /opt/src/
COPY Makefile /opt/src/
COPY test_security.sh /opt/src/

WORKDIR /opt/src

# Build with debug symbols for better Valgrind output
RUN make CFLAGS="-g -O0"
RUN chmod +x /opt/src/test_security.sh
RUN chown -R testuser:testgroup /opt/src

USER testuser

CMD ["/opt/src/test_security.sh"]
